############################################
# ðŸ” ObÈ›inem hostname-ul LoadBalancer-ului NGINX
############################################
- name: ObÈ›ine hostname-ul LoadBalancer-ului pentru NGINX
  shell: >
    kubectl get svc nginx-service -n default -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
  register: nginx_lb_hostname
  until: nginx_lb_hostname.stdout != ""
  retries: 20
  delay: 15

############################################
# ðŸ”§ SetÄƒm hostname-ul ca variabilÄƒ de lucru
############################################
- name: SetÄƒm variabila cu DNS
  set_fact:
    nginx_dns: "{{ nginx_lb_hostname.stdout }}"

############################################
# ðŸ“ GenerÄƒm payload-ul JSON pentru Route53
############################################
- name: CreÄƒm payload pentru DNS NGINX
  copy:
    dest: "/tmp/nginx-dns-record.json"
    content: |
      {
        "Comment": "Add CNAME record for NGINX",
        "Changes": [{
          "Action": "UPSERT",
          "ResourceRecordSet": {
            "Name": "app.k8s.it.com",
            "Type": "CNAME",
            "TTL": 300,
            "ResourceRecords": [{
              "Value": "{{ nginx_dns }}"
            }]
          }
        }]
      }

############################################
# ðŸ”„ PreluÄƒm variabila HOSTED_ZONE_ID din ENV
############################################
- name: SetÄƒm HOSTED_ZONE_ID direct (evitÄƒm lookup ENV)
  set_fact:
    HOSTED_ZONE_ID: "Z09193361LF7GGPR453HY"
    
############################################
# ðŸ›°ï¸ CreÄƒm Ã®nregistrarea DNS Ã®n Route53 pentru NGINX
############################################
- name: CreeazÄƒ Ã®nregistrare DNS Ã®n Route 53 pentru NGINX
  shell: >
    aws route53 change-resource-record-sets
    --hosted-zone-id "{{ HOSTED_ZONE_ID }}"
    --change-batch file:///tmp/nginx-dns-record.json
